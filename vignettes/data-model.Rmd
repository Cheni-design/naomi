---
title: "Naomi data model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Naomi data model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE, message = FALSE}
library(tidyverse)
library(datamodelr)
library(sf)
```

## Load datasets

```{r load_datasets, message = FALSE}
#' areas
area_levels <- naomi::mwi_area_levels
area_hierarchy <- naomi::mwi_area_hierarchy
area_boundaries <- naomi::mwi_area_boundaries

#' population
population_agesex <- naomi::mwi_population_agesex
age_group_meta <- naomi::get_age_groups()

fertility <- data.frame(area_id = character(0),
                        time = numeric(0),
                        age_group_id = integer(0),
                        asfr = numeric(0))

#' surveys
survey_meta <- naomi::mwi_survey_meta %>% select(-iso3)
survey_regions <- naomi::mwi_survey_regions %>% select(-iso3)
survey_clusters <- naomi::mwi_survey_clusters
survey_individuals <- naomi::mwi_survey_individuals
survey_biomarker <- naomi::mwi_survey_biomarker

survey_hiv_indicators <- naomi::mwi_survey_hiv_indicators %>% select(-iso3)
```

```{r create_model, include = FALSE}
dm_add_colors(
  dm_color_scheme(
    population = dm_palette(
      line_color = "#8064A2",
      header_bgcolor = "#B1A0C7",
      header_font = "#FFFFFF",
      bgcolor = "#E4DFEC"
    ),
    areas = dm_palette(
      line_color = "#C0504D",
      header_bgcolor = col2rgb("darkred") %>% {rgb(.[1], .[2], .[3], maxColorValue = 255)},
      header_font = "#FFFFFF",
      bgcolor = "#F2DCDB"
    )
  )
)

dm <- dm_from_data_frames(area_levels,
                          area_hierarchy, 
                          area_boundaries,
                          age_group_meta, 
                          population_agesex, 
                          fertility,
                          survey_meta, 
                          survey_regions, 
                          survey_clusters,
                          survey_individuals, 
                          survey_biomarker,
                          survey_hiv_indicators) %>%
 dm_set_display(
    list(
      areas = c("area_levels", "area_hierarchy", "area_boundaries"),
      population = c("age_group_meta", "population_agesex", "fertility"),
      accent4 = c("survey_meta", "survey_hiv_indicators"),
      accent6 = c("age_group_meta")
    )
  ) %>%
  dm_set_key("area_levels", "area_level") %>%
  dm_set_key("area_hierarchy", "area_id") %>%
  dm_set_key("area_boundaries", "area_id") %>%
  dm_set_key("age_group_meta", "age_group_id") %>%
  dm_set_key("population_agesex", c("area_id", "quarter_id", "sex", "age_group_id", "source")) %>%
  dm_set_key("fertility", c("area_id", "time", "age_group_id")) %>%
  dm_set_key("survey_meta", "survey_id") %>%
  dm_set_key("survey_regions", c("survey_id", "survey_region_id")) %>%
  dm_set_key("survey_clusters", c("survey_id", "cluster_id")) %>%
  dm_set_key("survey_individuals", c("survey_id", "cluster_id", "household", "line")) %>%
  dm_set_key("survey_biomarker", c("survey_id", "cluster_id", "household", "line")) %>%
  dm_set_key("survey_hiv_indicators", c("indicator", "survey_id", "area_id", "sex", "age_group_id")) %>%
  dm_add_references(
    area_hierarchy$area_level == area_levels$area_level,
    area_hierarchy$parent_area_id == area_hierarchy$area_id,
    area_boundaries$area_id == area_hierarchy$area_id,
    population_agesex$area_id == area_hierarchy$area_id,
    population_agesex$age_group_id == age_group_meta$age_group_id,
    fertility$area_id == population_agesex$area_id,
    fertility$time == population_agesex$time,
    fertility$age_group_id == population_agesex$age_group_id,
    population_agesex$age_group_id == age_group_meta$age_group_id,
    survey_regions$survey_id == survey_meta$survey_id,
    survey_regions$survey_region_area_id == area_hierarchy$area_id,
    survey_clusters$survey_id == survey_meta$survey_id,
    survey_clusters$survey_id == survey_regions$survey_id,
    survey_clusters$survey_region_id == survey_regions$survey_region_id,
    survey_clusters$geoloc_area_id == area_hierarchy$area_id,
    survey_individuals$survey_id == survey_clusters$survey_id,
    survey_individuals$cluster_id == survey_clusters$cluster_id,
    survey_biomarker$survey_id == survey_individuals$survey_id,
    survey_biomarker$cluster_id == survey_individuals$cluster_id,
    survey_biomarker$household == survey_individuals$household,
    survey_biomarker$line == survey_individuals$line,
    survey_hiv_indicators$survey_id == survey_meta$survey_id,
    survey_hiv_indicators$area_id == area_hierarchy$area_id,
    survey_hiv_indicators$age_group_id == age_group_meta$age_group_id
  ) %>%
  dm_set_segment(
    list(
      "Areas" = c("area_levels", "area_hierarchy", "area_boundaries"),
      "Population" = c("age_group_meta", "population_agesex", "fertility"),
      "Survey" = c("survey_meta", "survey_regions", "survey_clusters",
                   "survey_individuals", "survey_biomarker",
                   "survey_hiv_indicators")
    )
  )

```

## Data model diagramme

* Coloured tables are required inputs to Naomi model.
* White backgrond tables are in the ADR only.

```{r create_graph, fig.width = 7, fig.height = 10, fig.align = "center"}
#' Render graph
dm_create_graph(dm, rankdir = "BT", col_attr = c("column", "type")) %>%
                ## columnArrows = TRUE) %>%
  dm_render_graph()
```

## Areas data

#### Spatial geometry format

* `area_levels` contains metadata describing the levels in the area hierarchy for the country.
* `area_hierarchy` contains the nested hierarchy of area IDs at each level described in `area_levels`.
* `area_boundaries` defines the spatial boundaries for each area in `area_hierarchy`.

The fields `center_x` and `center_y` define in `area_hierarchy` defines longitude/latitude coordinates within the area. This field is currently optional. The R package will construct these centers from the boundaries if they are not provided.  They might wish to be provided for two reasons: 

1. Offset centers might be provided to avoid overlapping centroids when creating bubble plots (e.g. Zomba and Zomba City).
2. In future modelling we might rely on population-weighted centroids to estimate average distances between areas.

From a conceptual perspective, `area_hierarchy` and `area_boundaries` each have one record per `area_id` and it would make sense for them to be in a single table schema. They are separate schemas for convenience so that `area_hierarchy` can be saved as human-readable CSV file while `area_boundaries` is saved as `.geojson` format by default.

The figures below show example code for generating a typical plot from the Areas schemas:


```{r, fig.width=7, fig.height=4, warning=FALSE}
area_hierarchy %>%
  left_join(area_levels %>% select(area_level, area_level_label)) %>%
  mutate(area_level_label = area_level_label %>% fct_reorder(area_level)) %>%
  ggplot() +
  geom_sf(data = . %>% left_join(area_boundaries) %>% st_as_sf()) +
  geom_label(aes(center_x, center_y, label = area_sort_order), alpha = 0.5) +
  facet_wrap(~area_level_label, nrow = 1) +
  naomi:::th_map()
```
