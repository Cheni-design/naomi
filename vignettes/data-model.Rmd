---
title: "Naomi data model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Naomi data model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE, message = FALSE}
devtools::load_all()
library(tidyverse)
library(datamodelr)
library(sf)
```

## Load datasets

```{r load_datasets, message = FALSE}
#' areas
area_meta <- naomi::mwi_area_meta
areas <- naomi::mwi_areas
area_geom <- naomi::mwi_area_geom
area_boundaries <-
  left_join(
    st_read(system.file("extdata/areas/area_boundaries.geojson", package = "naomi")) %>%
    as.data.frame
   ,
    st_read(system.file("extdata/areas/area_centers.geojson", package = "naomi")) %>%
    as.data.frame %>%
    rename(center_adj = geometry)
)

#' population
population_agesex <- naomi::mwi_population_agesex
age_group_meta <- get_age_groups()

fertility <- data.frame(iso3 = character(0),
                        area_id = character(0),
                        time = numeric(0),
                        age_group_id = integer(0),
                        asfr = numeric(0))

#' surveys
survey_meta <- naomi::mwi_survey_meta
survey_regions <- naomi::mwi_survey_regions
survey_clusters <- naomi::mwi_survey_clusters
survey_individuals <- naomi::mwi_survey_individuals
survey_biomarker <- naomi::mwi_survey_biomarker

survey_hiv_indicators <- naomi::mwi_survey_hiv_indicators
```

```{r create_model, include = FALSE}
dm_add_colors(
  dm_color_scheme(
    population = dm_palette(
      line_color = "#8064A2",
      header_bgcolor = "#B1A0C7",
      header_font = "#FFFFFF",
      bgcolor = "#E4DFEC"
    ),
    areas = dm_palette(
      line_color = "#C0504D",
      header_bgcolor = col2rgb("darkred") %>% {rgb(.[1], .[2], .[3], maxColorValue = 255)},
      header_font = "#FFFFFF",
      bgcolor = "#F2DCDB"
    )
  )
)

dm <- dm_from_data_frames(area_meta, areas, area_geom, area_boundaries,
                          age_group_meta, population_agesex, fertility,
                          survey_meta, survey_regions, survey_clusters,
                          survey_individuals, survey_biomarker,
                          survey_hiv_indicators) %>%
  dm_set_key("area_meta", c("iso3", "area_level")) %>%
  dm_set_key("areas", c("iso3", "area_id")) %>%
  dm_set_key("area_geom", c("iso3", "area_id", "type")) %>%
  dm_set_key("area_boundaries", c("iso3", "area_id")) %>%
  dm_set_key("age_group_meta", "age_group_id") %>%
  dm_set_key("population_agesex", c("iso3", "area_id", "time", "sex", "age_group_id", "source")) %>%
  dm_set_key("fertility", c("iso3", "area_id", "time", "age_group_id")) %>%
  dm_set_key("survey_meta", "survey_id") %>%
  dm_set_key("survey_regions", c("survey_id", "survey_region_id")) %>%
  dm_set_key("survey_clusters", c("survey_id", "cluster_id")) %>%
  dm_set_key("survey_individuals", c("survey_id", "cluster_id", "household", "line")) %>%
  dm_set_key("survey_biomarker", c("survey_id", "cluster_id", "household", "line")) %>%
  dm_set_key("survey_hiv_indicators", c("indicator", "survey_id", "iso3", "area_id", "sex", "age_group_id")) %>%
  dm_add_references(
    areas$iso3 == area_meta$iso3,
    areas$area_level == area_meta$area_level,
    area_geom$iso3 == areas$iso3,
    area_geom$area_id == areas$area_id,
    area_boundaries$iso3 == areas$iso3,
    area_boundaries$area_id == areas$area_id,
    population_agesex$iso3 == areas$iso3,
    population_agesex$area_id == areas$area_id,
    population_agesex$age_group_id == age_group_meta$age_group_id,
    fertility$iso3 == population_agesex$iso3,
    fertility$area_id == population_agesex$area_id,
    fertility$time == population_agesex$time,
    fertility$age_group_id == population_agesex$age_group_id,
    population_agesex$age_group_id == age_group_meta$age_group_id,
    survey_regions$survey_id == survey_meta$survey_id,
    survey_regions$survey_region_area_id == areas$area_id,
    survey_clusters$survey_id == survey_meta$survey_id,
    survey_clusters$survey_id == survey_regions$survey_id,
    survey_clusters$survey_region_id == survey_regions$survey_region_id,
    survey_clusters$geoloc_area_id == areas$area_id,
    survey_individuals$survey_id == survey_clusters$survey_id,
    survey_individuals$cluster_id == survey_clusters$cluster_id,
    survey_biomarker$survey_id == survey_individuals$survey_id,
    survey_biomarker$cluster_id == survey_individuals$cluster_id,
    survey_biomarker$household == survey_individuals$household,
    survey_biomarker$line == survey_individuals$line,
    survey_hiv_indicators$survey_id == survey_meta$survey_id,
    survey_hiv_indicators$iso3 == areas$iso3,
    survey_hiv_indicators$area_id == areas$area_id,
    survey_hiv_indicators$age_group_id == age_group_meta$age_group_id
  ) %>%
  dm_set_segment(
    list(
      "Areas" = c("area_meta", "areas", "area_geom", "area_boundaries"),
      "Population" = c("age_group_meta", "population_agesex", "fertility"),
      "Survey" = c("survey_meta", "survey_regions", "survey_clusters",
                   "survey_individuals", "survey_biomarker",
                   "survey_hiv_indicators")
    )
  ) %>%
  dm_set_display(
    list(
      areas = c("area_meta", "areas", "area_geom"),
      population = c("age_group_meta", "population_agesex", "fertility"),
      accent4 = c("survey_meta", "survey_hiv_indicators"),
      accent6 = c("area_boundaries", "age_group_meta")
    )
  )


```

## Data model diagramme

* Coloured tables are required inputs to Naomi model.
* White backgrond tables are in the ADR only.

```{r create_graph, fig.width = 7, fig.height = 10, fig.align = "center"}
#' Render graph
dm_create_graph(dm, rankdir = "BT", col_attr = c("column", "type")) %>%
                ## columnArrows = TRUE) %>%
  dm_render_graph()
```

## Data model questions

#### Spatial geometry format

The area dataset may need to retain both area boundaries as polygons and area centroids, or adjusted centroids for plotting area level labels or statistics. Centroids are easily calculated from the polygons, however in some cases, points used for plotting or labelling may need to be manually adjusted to avoid overlap, and desire to save these adjusted point references. For example, Zomba and Zomba City in Malawi. 

The data model above shows two approaches for capturing these data, only one of which should be retained:

* The `area_boundaries` table is in 'wide' format with a column for boundary polygons, a column for centroid points, and column for adjusted centroid points. This wide format is accepted (under protest) by R's `sf` class, but GeoJSON and ESRI .shp formats do not admit multiple geometries, so polygon and point would need to be saved as separate layers in those formats.
* The `area_geom` table is in 'long format' with an additional `type` columns specifying _boundary_, _centroid_, or _adjusted_centroid_. The type is filtered to select the desired geometry for a given plotting purpose. GeoJSON format accepts both polygon and point data in a single collection, however ESRI .shp format does not, requiring each type to be saved as a separate layer.

Our current preference is to favour the `area_geom` 'long' format and save geometry data as GeoJSON format as default. It may also be that there are suitable algorithmic solutions to offsetting points for plotting such that saving adjusted centroid points is not needed.

The figures below show example code for generating a typical plot with either boundary data format.

```{r, fig.width=7, fig.height=4, warning=FALSE}
#' Using area_geom
areas %>%
  left_join(area_boundaries) %>%
  st_as_sf %>%
  left_join(area_meta %>% select(iso3, area_level, area_level_label)) %>%
  mutate(area_level_label = area_level_label %>% fct_reorder(area_level)) %>%
  ggplot() +
  geom_sf() +
  geom_sf_label(aes(label = area_sort_order), data = . %>% st_set_geometry("center_adj")) +
  facet_wrap(~area_level_label, nrow = 1) +
  th_map() +
  ggtitle("Using area_boundaries")

#' Using area_geom
areas %>%
  left_join(area_geom) %>%
  st_as_sf %>%
  left_join(area_meta %>% select(iso3, area_level, area_level_label)) %>%
  mutate(area_level_label = area_level_label %>% fct_reorder(area_level)) %>%
  ggplot() +
  geom_sf(data = . %>% filter(type == "boundary")) +
  geom_sf_label(aes(label = area_sort_order), data = . %>% filter(type == "center_adj")) +
  facet_wrap(~area_level_label, nrow = 1) +
  th_map() +
  ggtitle("Using area_geom")
